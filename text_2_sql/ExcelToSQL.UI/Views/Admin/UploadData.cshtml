@{
    ViewData["Title"] = "Upload Excel Files";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container">
    <!-- Upload Interface -->
    <div class="upload-container">
        <div class="upload-header">
            <h5 class="upload-title">Upload Excel Files</h5>
        </div>

        <!-- Dropzone -->
        <form action="/api/upload" class="dropzone" id="excel-upload">
            <div class="dz-message">
                <i class="bi bi-cloud-upload fs-2 mb-2"></i>
                <p>Drag and drop files here or click to browse</p>
            </div>
        </form>
    </div>

    <!-- Uploaded Files -->
    <div class="card mt-4">
        <h5 class="card-header bg-light">
            <i class="bi bi-file-earmark-spreadsheet me-2"></i>Uploaded Files
        </h5>
        <div class="card-body">
            <div id="file-list" class="list-group">
                <!-- Files will be listed here -->
            </div>
            <div id="no-files-message" class="text-center text-muted py-3">
                No files uploaded yet
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        Dropzone.autoDiscover = false;

        $(document).ready(function() {
            loadUploadedFiles();

            const dropzone = new Dropzone("#excel-upload", {
                acceptedFiles: ".xlsx,.xls,.csv",
                maxFilesize: 10, // MB
                createImageThumbnails: false,
                addRemoveLinks: true,
                dictRemoveFile: "Remove",
                init: function() {
                    this.on("success", function(file, response) {
                        loadUploadedFiles();
                    });
                    
                    this.on("error", function(file, errorMessage) {
                        // Silently remove the file on error
                        this.removeFile(file);
                    });
                }
            });
        });

        function loadUploadedFiles() {
            $.ajax({
                url: '/api/files',
                method: 'GET',
                success: function(files) {
                    const fileList = $('#file-list');
                    const noFilesMsg = $('#no-files-message');
                    
                    if (files && files.length > 0) {
                        fileList.empty();
                        noFilesMsg.hide();
                        
                        files.forEach(file => {
                            const item = $(`
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="bi bi-file-earmark-spreadsheet me-2"></i>
                                        ${file.name}
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <small class="text-muted me-3">
                                            Uploaded: ${new Date(file.uploadDate).toLocaleString()}
                                        </small>
                                        <button class="btn btn-link text-danger p-0" onclick="deleteFile('${file.name}')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            `);
                            fileList.append(item);
                        });
                    } else {
                        fileList.empty();
                        noFilesMsg.show();
                    }
                },
                error: function() {
                    // Silently handle error by showing the no files message
                    $('#file-list').empty();
                    $('#no-files-message').show();
                }
            });
        }

        function deleteFile(fileName) {
            if (confirm('Are you sure you want to delete this file?')) {
                $.ajax({
                    url: '/api/files/' + encodeURIComponent(fileName),
                    method: 'DELETE',
                    success: function() {
                        loadUploadedFiles();
                    },
                    error: function() {
                        // Silently reload the file list on error
                        loadUploadedFiles();
                    }
                });
            }
        }
    </script>
}
